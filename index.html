<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spots de p√™che ‚Äì Carte + M√©t√©o (ajout simplifi√©)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root { --bg:#0b1220; --panel:#10192b; --muted:#7d8fb3; --text:#e6edf7; --border:#22304a; --accent:#36b37e; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #app{display:grid;grid-template-columns:320px 1fr;height:100%}
    #sidebar{background:#10192b;border-right:1px solid var(--border);display:flex;flex-direction:column}
    header{padding:14px 16px;border-bottom:1px solid var(--border)}
    #controls{padding:12px;display:grid;gap:8px}
    .btn{background:#162339;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.primary{background:#153a2d;border-color:#1f5f49}
    #map{height:100%;width:100%;position:relative}
    .fab{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);z-index:1000;background:#153a2d;border:2px solid #1f5f49;color:#e6edf7;padding:12px 16px;border-radius:999px;font-weight:700;box-shadow:0 6px 20px rgba(0,0,0,.35)}
    .leaflet-control-container{z-index:1001}
    .item{border:1px solid var(--border);border-radius:12px;background:#0f1a2c;padding:10px;margin:8px}
    .meta{font-size:12px;color:var(--muted)}
    @media (max-width:900px){#app{grid-template-columns:1fr;grid-template-rows:45% 55%}#sidebar{order:2}#map{order:1}}
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <header>
        <h1>Spots de p√™che</h1>
        <p>Ajoutez vos spots. Appui long sur la carte pour cr√©er un spot, ou utilisez le bouton ‚ÄúAjouter ici‚Äù.</p>
      </header>
      <div id="controls">
        <button id="addBtn" class="btn primary">‚ûï Mode ‚Äúcliquer sur la carte‚Äù</button>
      </div>
      <div class="item">
        <strong>M√©t√©o (centre de la carte)</strong>
        <div class="meta" id="mapCenterWeatherMeta">‚Äî</div>
        <div class="meta" id="mapCenterWeatherBody">Chargement‚Ä¶</div>
      </div>
    </aside>
    <div id="map">
      <button id="addHereBtn" class="fab">‚ûï Ajouter ici (au centre)</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Base
    const STORAGE_KEY='spots-peche:v3-plus-ajout';
    let addingMode=false;
    let spots=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    const markers=new Map();
    const map=L.map('map').setView([46.5,-2],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);

    // Helpers
    const uid=()=>Math.random().toString(36).slice(2,9);
    const save=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(spots));
    const color=cat=>({Bar:'#4caf50',Loup:'#ff9800',Daurade:'#03a9f4'})[cat]||'#9e9e9e';
    const icon=cat=>L.divIcon({className:'pin',html:`<div style="width:18px;height:18px;border-radius:50%;background:${color(cat)};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.25)"></div>`,iconSize:[18,18],iconAnchor:[9,9]});
    const d2c=d=>['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'][Math.round(d/22.5)%16]||'‚Äî';
    const j=async u=>{const r=await fetch(u);if(!r.ok)throw new Error(r.status);return r.json();}
    const wx=async (lat,lng)=>{
      const a=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,wind_speed_10m,wind_gusts_10m,wind_direction_10m,precipitation&timezone=auto`;
      const b=`https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lng}&current=wave_height,wind_wave_period,wind_wave_direction&timezone=auto`;
      const [m,mar]=await Promise.allSettled([j(a),j(b)]);
      return {c:m.value?.current,mar:mar.value?.current};
    };
    const wxHTML=w=>!w||!w.c?'<em>Indispo</em>':`üå°Ô∏è ${Math.round(w.c.temperature_2m)}¬∞C ¬∑ üí® ${Math.round(w.c.wind_speed_10m)} m/s dir ${d2c(w.c.wind_direction_10m)}${w.mar?` ¬∑ üåä ${w.mar.wave_height?.toFixed?.(1)||'‚Äî'} m / ${Math.round(w.mar.wind_wave_period||0)} s`:''}`;

    // UI refs
    const addBtn=document.getElementById('addBtn');
    const addHereBtn=document.getElementById('addHereBtn');
    const meta=document.getElementById('mapCenterWeatherMeta');
    const body=document.getElementById('mapCenterWeatherBody');

    // Weather for map center
    function refreshCenterWx(){
      const c=map.getCenter();
      meta.textContent=`${c.lat.toFixed(4)}, ${c.lng.toFixed(4)}`;
      body.textContent='Chargement‚Ä¶';
      wx(c.lat,c.lng).then(w=>body.innerHTML=wxHTML(w)).catch(()=>body.textContent='Erreur m√©t√©o');
    }
    map.on('moveend',refreshCenterWx); refreshCenterWx();

    // Add spot helpers
    function openForm(s,isNew=false){
      const html=`<form class="popup-form">
        <label>Nom <input name="name" value="${s.name||''}" required></label>
        <label>Esp√®ce <select name="cat"><option ${s.cat==='Bar'?'selected':''}>Bar</option><option ${s.cat==='Loup'?'selected':''}>Loup</option><option ${s.cat==='Daurade'?'selected':''}>Daurade</option><option ${s.cat==='Autre'?'selected':''}>Autre</option></select></label>
        <label>Note (1-5) <input type="number" min="1" max="5" name="note" value="${s.note||3}"></label>
        <label>Description <textarea name="desc" rows="3">${s.desc||''}</textarea></label>
        <div style="display:flex;gap:8px;justify-content:space-between">
          <button class="btn primary" type="submit" style="flex:1">${isNew?'Ajouter':'Mettre √† jour'}</button>
          ${!isNew?'<button class="btn" type="button" data-del>Supprimer</button>':''}
        </div>
      </form>`;
      const m=markers.get(s.id)||L.marker([s.lat,s.lng],{draggable:true,icon:icon(s.cat)}).addTo(map);
      m.bindPopup(html).openPopup();
      m.on('dragend',ev=>{const p=ev.target.getLatLng();const i=spots.findIndex(x=>x.id===s.id);if(i>-1){spots[i].lat=p.lat;spots[i].lng=p.lng;save();}});
      m.on('popupopen',()=>{
        const el=m.getPopup().getElement();
        const form=el.querySelector('form');
        form.addEventListener('submit',e=>{e.preventDefault();const d=new FormData(form);const upd={...s,name:d.get('name'),cat:d.get('cat'),note:Number(d.get('note'))||3,desc:d.get('desc')};if(isNew){spots.push(upd);markers.set(upd.id,m);}else{const i=spots.findIndex(x=>x.id===s.id);if(i>-1)spots[i]=upd;} m.setIcon(icon(upd.cat)); save(); m.closePopup();});
        const del=el.querySelector('[data-del]'); if(del) del.addEventListener('click',()=>{if(!confirm('Supprimer ce spot ?'))return;const i=spots.findIndex(x=>x.id===s.id);if(i>-1)spots.splice(i,1); save(); map.removeLayer(m); markers.delete(s.id);});
      });
      markers.set(s.id,m);
    }

    // Button: toggle click-to-add
    addBtn.addEventListener('click',()=>{
      addingMode=!addingMode;
      addBtn.textContent = addingMode ? 'üñ±Ô∏è Cliquez sur la carte (mode actif)' : '‚ûï Mode ‚Äúcliquer sur la carte‚Äù';
      addBtn.classList.toggle('primary', addingMode);
    });

    // Map click when mode enabled
    map.on('click',e=>{
      if(!addingMode) return;
      const s={id:uid(),name:'',cat:'Bar',note:3,desc:'',lat:e.latlng.lat,lng:e.latlng.lng};
      addingMode=false; addBtn.textContent='‚ûï Mode ‚Äúcliquer sur la carte‚Äù'; addBtn.classList.remove('primary');
      openForm(s,true);
    });

    // Long-press / context menu to add anywhere (works mobile)
    map.on('contextmenu',e=>{
      const s={id:uid(),name:'',cat:'Bar',note:3,desc:'',lat:e.latlng.lat,lng:e.latlng.lng};
      openForm(s,true);
    });

    // Add-here button (center of map)
    addHereBtn.addEventListener('click',()=>{
      const c=map.getCenter();
      const s={id:uid(),name:'',cat:'Bar',note:3,desc:'',lat:c.lat,lng:c.lng};
      openForm(s,true);
    });

    // Geo start
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],12),()=>{}, {enableHighAccuracy:true,timeout:2000});
    }
  </script>
</body>
</html>

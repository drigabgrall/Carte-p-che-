<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spots de p√™che ‚Äì Carte + M√©t√©o</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <style>
    :root { --bg:#0b1220; --panel:#10192b; --muted:#7d8fb3; --text:#e6edf7; --border:#22304a; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', Arial; }
    #app { display:grid; grid-template-columns:320px 1fr; height:100%; }
    #sidebar { background:#10192b; border-right:1px solid var(--border); display:flex; flex-direction:column; }
    header { padding:14px 16px; border-bottom:1px solid var(--border); }
    header h1 { margin:0; font-size:18px; }
    header p { margin:6px 0 0; color:var(--muted); font-size:12px; }
    #controls { padding:12px 12px 8px; display:grid; gap:8px; }
    .btn { background:#162339; color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn.primary { background:#153a2d; border-color:#1f5f49; }
    .btn.danger { background:#3a1620; border-color:#5f1f31; }
    .row { display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; }
    input, select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1a2c; color:var(--text); }
    textarea { resize:vertical; }
    #list { overflow:auto; padding:8px 8px 80px; }
    .item { border:1px solid var(--border); border-radius:12px; padding:10px; margin:8px; background:#0f1a2c; }
    .item h3 { margin:0; font-size:14px; }
    .meta { color:var(--muted); font-size:12px; }
    .actions { margin-top:8px; display:flex; gap:8px; }
    #map { height:100%; width:100%; }
    .leaflet-popup-content { margin:8px; }
    .popup-form { display:grid; gap:8px; min-width:260px; }
    .legend { display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--muted); padding:0 12px 12px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; }
    .cat-Bar { background:#4caf50; } .cat-Loup{ background:#ff9800; } .cat-Daurade{ background:#03a9f4; } .cat-Autre{ background:#9e9e9e; }
    @media (max-width:900px){ #app{ grid-template-columns:1fr; grid-template-rows:45% 55%; } #sidebar{ order:2; } #map{ order:1; } }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <header>
        <h1>Spots de p√™che</h1>
        <p>Ajoutez vos coins favoris sur la carte, sauvegard√©s dans votre navigateur.</p>
      </header>
      <div id="controls">
        <div class="row">
          <button id="addBtn" class="btn primary">‚ûï Ajouter un spot</button>
          <button id="locateBtn" class="btn" title="Me localiser">üìç</button>
        </div>
        <input id="search" type="search" placeholder="Rechercher par nom / esp√®ce / note‚Ä¶"/>
        <div class="row">
          <select id="filterCat">
            <option value="">Toutes les esp√®ces</option>
            <option>Bar</option><option>Loup</option><option>Daurade</option><option>Autre</option>
          </select>
          <select id="filterNote">
            <option value="">Note</option><option value="5">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option><option value="4">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option><option value="3">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option><option value="2">‚≠êÔ∏è‚≠êÔ∏è</option><option value="1">‚≠êÔ∏è</option>
          </select>
        </div>
        <div class="row">
          <button id="exportBtn" class="btn">‚¨áÔ∏è Exporter</button>
          <button id="importBtn" class="btn">‚¨ÜÔ∏è Importer</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none"/>
        </div>
        <div class="legend">
          <span><span class="dot cat-Bar"></span>Bar</span>
          <span><span class="dot cat-Loup"></span>Loup</span>
          <span><span class="dot cat-Daurade"></span>Daurade</span>
          <span><span class="dot cat-Autre"></span>Autre</span>
        </div>
      </div>

      <div class="item" id="mapCenterWeather" style="margin:8px;">
        <h3 style="margin:0 0 4px 0;">M√©t√©o (centre de la carte)</h3>
        <div class="meta" id="mapCenterWeatherMeta">‚Äî</div>
        <div id="mapCenterWeatherBody" class="meta">Chargement‚Ä¶</div>
      </div>

      <div id="list"></div>
    </aside>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    const STORAGE_KEY='spots-peche:v2-weather';
    let addingMode=false;
    let spots=loadSpots();
    const markers=new Map();

    const map=L.map('map',{zoomControl:false}).setView([46.5,-2],6);
    L.control.zoom({position:'bottomright'}).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; contributeurs <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'}).addTo(map);

    const addBtn=document.getElementById('addBtn');
    const locateBtn=document.getElementById('locateBtn');
    const exportBtn=document.getElementById('exportBtn');
    const importBtn=document.getElementById('importBtn');
    const fileInput=document.getElementById('fileInput');
    const listEl=document.getElementById('list');
    const searchEl=document.getElementById('search');
    const filterCatEl=document.getElementById('filterCat');
    const filterNoteEl=document.getElementById('filterNote');

    function uid(){return Math.random().toString(36).slice(2,9);}
    function loadSpots(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{return[]}}
    function saveSpots(){localStorage.setItem(STORAGE_KEY,JSON.stringify(spots));}
    function stars(n){return '‚≠êÔ∏è'.repeat(n||0);}
    function categoryColor(cat){switch(cat){case 'Bar':return '#4caf50';case 'Loup':return '#ff9800';case 'Daurade':return '#03a9f4';default:return '#9e9e9e';}}
    function makeIcon(cat){const color=categoryColor(cat);return L.divIcon({className:'custom-pin',html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid white;box-shadow:0 0 0 2px rgba(0,0,0,.25)"></div>`,iconSize:[18,18],iconAnchor:[9,9]});}

    function degToCompass(deg){const d=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];return d[Math.round(deg/22.5)%16]||'‚Äî';}
    async function fetchJSON(url){const r=await fetch(url);if(!r.ok)throw new Error('HTTP '+r.status);return r.json();}
    async function getLiveWeather(lat,lng){
      const metUrl=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,wind_speed_10m,wind_gusts_10m,wind_direction_10m,precipitation,weather_code&timezone=auto`;
      const marUrl=`https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lng}&current=wave_height,wind_wave_direction,wind_wave_period&timezone=auto`;
      const [met,mar]=await Promise.allSettled([fetchJSON(metUrl),fetchJSON(marUrl)]);
      const current=met.status==='fulfilled'?met.value.current:null;
      const marine=mar.status==='fulfilled'?mar.value.current:null;
      return {current,marine};
    }
    function weatherSummaryHTML(w){
      if(!w||!w.current) return '<em>Indispo pour le moment.</em>';
      const c=w.current;
      const t=c.temperature_2m!=null?`${Math.round(c.temperature_2m)}¬∞C`:'‚Äî';
      const ws=c.wind_speed_10m!=null?`${Math.round(c.wind_speed_10m)} m/s`:'‚Äî';
      const wg=c.wind_gusts_10m!=null?`${Math.round(c.wind_gusts_10m)} m/s`:null;
      const wd=c.wind_direction_10m!=null?`${degToCompass(c.wind_direction_10m)} (${Math.round(c.wind_direction_10m)}¬∞)`:'‚Äî';
      const pr=c.precipitation!=null?`${c.precipitation} mm`:'‚Äî';
      let marine='';
      if(w.marine){const mh=w.marine.wave_height;const mp=w.marine.wind_wave_period;const md=w.marine.wind_wave_direction;
        const mTxt=(mh!=null?`${mh.toFixed(1)} m`:'‚Äî')+(mp!=null?` ¬∑ ${Math.round(mp)} s`: '')+(md!=null?` ¬∑ dir ${degToCompass(md)}`:'');
        marine=`<div>üåä Houle: <strong>${mTxt}</strong></div>`;}
      return `<div>üå°Ô∏è Temp√©rature: <strong>${t}</strong></div><div>üí® Vent: <strong>${ws}${wg?` (rafales ${wg})`:''}</strong> ¬∑ <span>dir ${wd}</span></div><div>üåßÔ∏è Pr√©cipitations: <strong>${pr}</strong></div>${marine}`;
    }
    function setMapCenterWeather(){
      const center=map.getCenter();
      const meta=document.getElementById('mapCenterWeatherMeta');
      const body=document.getElementById('mapCenterWeatherBody');
      if(!meta||!body) return;
      meta.textContent=`${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
      body.textContent='Chargement‚Ä¶';
      getLiveWeather(center.lat, center.lng).then(w=>{body.innerHTML=weatherSummaryHTML(w);}).catch(()=>{body.textContent='Impossible de r√©cup√©rer la m√©t√©o.';});
    }

    addBtn.addEventListener('click',()=>{addingMode=!addingMode;addBtn.textContent=addingMode?'üñ±Ô∏è Cliquez sur la carte':'‚ûï Ajouter un spot';addBtn.classList.toggle('primary',addingMode);});
    map.on('click',e=>{if(!addingMode)return;const {lat,lng}=e.latlng;addingMode=false;addBtn.textContent='‚ûï Ajouter un spot';addBtn.classList.remove('primary');openSpotForm({id:uid(),name:'',cat:'Bar',note:3,desc:'',date:new Date().toISOString().slice(0,10),lat,lng},true);});
    locateBtn.addEventListener('click',()=>{map.locate({setView:true,maxZoom:14,enableHighAccuracy:true});});

    function openSpotForm(spot,isNew=false){
      const formHtml=`
        <form class="popup-form">
          <label>Nom <input name="name" value="${spot.name||''}" placeholder="Ex. Pointe rocheuse" required /></label>
          <label>Esp√®ce
            <select name="cat">
              <option ${spot.cat==='Bar'?'selected':''}>Bar</option>
              <option ${spot.cat==='Loup'?'selected':''}>Loup</option>
              <option ${spot.cat==='Daurade'?'selected':''}>Daurade</option>
              <option ${spot.cat==='Autre'?'selected':''}>Autre</option>
            </select>
          </label>
          <label>Date <input type="date" name="date" value="${spot.date||''}" /></label>
          <label>Note (1-5) <input type="number" name="note" min="1" max="5" value="${spot.note||3}" /></label>
          <label>Description <textarea name="desc" rows="3" placeholder="Mar√©e, vent, leurre‚Ä¶">${spot.desc||''}</textarea></label>
          <div style="display:flex; gap:8px; justify-content:space-between;">
            <button type="submit" class="btn primary" style="flex:1">${isNew?'Ajouter':'Mettre √† jour'}</button>
            ${!isNew?'<button type="button" data-action="delete" class="btn danger">Supprimer</button>':''}
          </div>
          <div class="item" style="margin-top:8px;">
            <div class="meta">M√©t√©o en direct</div>
            <div class="meta" id="wx-${spot.id}">Chargement‚Ä¶</div>
          </div>
        </form>`;
      const marker=markers.get(spot.id)||L.marker([spot.lat,spot.lng],{draggable:true,icon:makeIcon(spot.cat)}).addTo(map);
      marker.bindPopup(formHtml).openPopup();
      marker.on('dragend',ev=>{const pos=ev.target.getLatLng();const idx=spots.findIndex(s=>s.id===spot.id);if(idx>-1){spots[idx].lat=pos.lat;spots[idx].lng=pos.lng;saveSpots();renderList();}});
      marker.on('popupopen',()=>{
        const popupEl=marker.getPopup().getElement();
        const form=popupEl.querySelector('form');
        const out=popupEl.querySelector(`#wx-${spot.id}`);
        getLiveWeather(spot.lat,spot.lng).then(w=>{if(out) out.innerHTML=weatherSummaryHTML(w);}).catch(()=>{if(out) out.textContent='Impossible de r√©cup√©rer la m√©t√©o.';});
        form.addEventListener('submit',e=>{e.preventDefault();const data=new FormData(form);const updated={...spot,name:data.get('name'),cat:data.get('cat'),date:data.get('date'),note:Math.max(1,Math.min(5,Number(data.get('note'))||3)),desc:data.get('desc')};if(isNew){spots.push(updated);markers.set(updated.id,marker);}else{const idx=spots.findIndex(s=>s.id===spot.id);if(idx>-1)spots[idx]=updated;}marker.setIcon(makeIcon(updated.cat));saveSpots();renderList();marker.closePopup();});
        const delBtn=popupEl.querySelector('[data-action="delete"]');
        if(delBtn) delBtn.addEventListener('click',()=>{if(!confirm('Supprimer ce spot ?'))return;const idx=spots.findIndex(s=>s.id===spot.id);if(idx>-1)spots.splice(idx,1);saveSpots();renderList();map.removeLayer(marker);markers.delete(spot.id);});
      });
      markers.set(spot.id,marker);
    }

    function renderList(){
      const q=(searchEl.value||'').toLowerCase();
      const cat=filterCatEl.value;
      const note=Number(filterNoteEl.value||0);
      listEl.innerHTML='';
      spots.filter(s=>(!cat||s.cat===cat)).filter(s=>(!note||(s.note||0)>=note)).filter(s=>{const blob=`${s.name} ${s.cat} ${s.desc} ${s.note}`.toLowerCase();return blob.includes(q);}).sort((a,b)=>(b.date||'').localeCompare(a.date||'')).forEach(s=>{
        const item=document.createElement('div');item.className='item';
        item.innerHTML=`<h3>${s.name||'(Sans nom)'} ¬∑ <span class="meta">${s.cat}</span></h3><div class="meta">${s.date||''} ¬∑ ${stars(s.note)}</div><p>${(s.desc||'').slice(0,200)}</p><div class="actions"><button class="btn" data-action="go">Voir</button><button class="btn" data-action="edit">√âditer</button></div>`;
        item.querySelector('[data-action="go"]').addEventListener('click',()=>{const m=markers.get(s.id);if(m){map.setView(m.getLatLng(),Math.max(map.getZoom(),14));m.openPopup();}});
        item.querySelector('[data-action="edit"]').addEventListener('click',()=>openSpotForm(s,false));
        listEl.appendChild(item);
      });
    }
    searchEl.addEventListener('input',renderList);
    filterCatEl.addEventListener('change',renderList);
    filterNoteEl.addEventListener('change',renderList);

    exportBtn.addEventListener('click',()=>{const data=JSON.stringify({type:'spots-peche',version:2,items:spots},null,2);const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='spots-peche.json';a.click();URL.revokeObjectURL(url);});
    importBtn.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(data.type!=='spots-peche'||!Array.isArray(data.items))throw new Error('Format invalide');spots=data.items.map(s=>({...s,id:s.id||uid()}));saveSpots();markers.forEach(m=>map.removeLayer(m));markers.clear();spots.forEach(s=>{const m=L.marker([s.lat,s.lng],{draggable:true,icon:makeIcon(s.cat)}).addTo(map);markers.set(s.id,m);m.on('dragend',ev=>{const pos=ev.target.getLatLng();const idx=spots.findIndex(x=>x.id===s.id);if(idx>-1){spots[idx].lat=pos.lat;spots[idx].lng=pos.lng;saveSpots();renderList();}});m.on('click',()=>openSpotForm(s,false));});renderList();alert('Import r√©ussi ‚úÖ');}catch(err){alert('√âchec de l\'import: '+err.message);}};reader.readAsText(file);e.target.value='';});

    spots.forEach(s=>{const m=L.marker([s.lat,s.lng],{draggable:true,icon:makeIcon(s.cat)}).addTo(map);markers.set(s.id,m);m.on('dragend',ev=>{const pos=ev.target.getLatLng();const idx=spots.findIndex(x=>x.id===s.id);if(idx>-1){spots[idx].lat=pos.lat;spots[idx].lng=pos.lng;saveSpots();renderList();}});m.on('click',()=>openSpotForm(s,false));});
    renderList();
    setMapCenterWeather();
    map.on('moveend',setMapCenterWeather);
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{map.setView([pos.coords.latitude,pos.coords.longitude],11);setTimeout(setMapCenterWeather,300);},()=>{}, {enableHighAccuracy:true,timeout:2000});}
  </script>
</body>
</html>
